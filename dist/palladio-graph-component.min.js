angular.module("palladioGraphComponent",["palladio.services","palladio"]).run(["componentService",function(t){var n=function(t,n){t.showSettings=void 0===t.showSettings||t.showSettings,t.graphHeight=void 0===t.height?"100%":t.height,t.functions={};var i='<div class="with-settings" data-palladio-graph-view-with-settings ';return i+="show-settings=showSettings ",i+="graph-height=graphHeight ",i+="functions=functions ",i+="></div>"};t.register("graph",n)}]).directive("palladioGraphView",["palladioService",function(t){return{scope:{linkDimension:"=",graphHeight:"=",showLinks:"=",showLabels:"=",nodeSize:"=",highlightSource:"=",highlightTarget:"=",countBy:"@",countDescription:"@",aggregationType:"@",aggregateKey:"@",readInternalState:"=",setInternalState:"=",getSvg:"="},link:function(n,i,e){function o(){n.linkDimension&&(m.width(r).height(d).showLinks(n.showLinks).showLabels(n.showLabels).nodeSize(n.nodeSize).searchText(c).circle(n.circleLayout),h.attr("width",r).attr("height",d),u.attr("width",r).attr("height",d).datum(a()).call(m),n.highlightSource&&m.highlightSource(),n.highlightTarget&&m.highlightTarget())}function a(){if(!p){var t=crossfilterHelpers.countByDimensionWithInitialCountAndData(function(t){return t[n.countBy]},function(t,i,e){return void 0===i&&(i={source:n.linkDimension.accessor(t)[0],target:n.linkDimension.accessor(t)[1],data:t,agg:0,initialAgg:0}),"add"===e?("COUNT"===n.aggregationType?i.agg++:i.agg=i.agg+(+t[n.aggregateKey]?+t[n.aggregateKey]:0),i.agg>i.initialAgg&&(i.initialAgg=i.agg)):"COUNT"===n.aggregationType?i.agg--:i.agg=i.agg-(+t[n.aggregateKey]?+t[n.aggregateKey]:0),i});p=n.linkDimension.group().reduce(t.add,t.remove,t.init).order(function(t){return t.data.agg})}return p.top(1/0).map(function(t){return t.value}).filter(function(t){return t.data.agg>0})}function l(){i.height(n.graphHeight?n.graphHeight.slice(0,n.graphHeight.length-2):$(window).height())}var g=[],s="graphView"+Math.floor(1e4*Math.random());n.readInternalState=function(t){return t.fixedNodes=m.fixedNodes(),t},n.setInternalState=function(t){return m.fixedNodes(t.fixedNodes),t},n.getSvg=function(){return m.getSvg()};var c="",r=i.width()||1e3,d=n.graphHeight&&n.graphHeight.indexOf("%")===-1?n.graphHeight.slice(0,n.graphHeight.length-2):i.height()||800,h=d3.select(i[0]).append("canvas").attr("style","position: absolute; left: 0; top: 0; z-index: -100"),u=d3.select(i[0]).append("svg:svg"),m=d3.graph(),p=null;n.$on("zoomIn",function(){m.zoomIn()}),n.$on("zoomOut",function(){m.zoomOut()}),n.$on("zoomToData",function(){m.zoomToData()}),g.push(t.onUpdate(s,function(){i.is(":visible")&&o()})),n.$watch(function(){return i.is(":visible")},o),n.$on("resetNodes",function(){m.resetNodes()}),n.$watch("linkDimension",function(){m.reset(),p&&(p.remove(),p=null),o()}),n.$watchGroup(["countBy","aggregationType","aggregationKey"],function(){m.reset(),p&&(p.remove(),p=null),o()}),n.$watch("showLinks",o),n.$watch("showLabels",o),n.$watch("nodeSize",o),g.push(t.onSearch(s,function(t){c=t,o()})),n.$watch("circleLayout",o),n.$watch("highlightSource",function(t,i){t!==i&&(t?(n.highlightTarget=!1,m.highlightSource()):n.highlightTarget||m.removeHighlight())}),n.$watch("highlightTarget",function(t,i){t!==i&&(t?(n.highlightSource=!1,m.highlightTarget()):n.highlightSource||m.removeHighlight())}),n.$on("resize",function(){r=i.width(),o()}),$(document).ready(l),$(window).resize(l)}}}]).directive("palladioGraphViewWithSettings",["exportService","palladioService","dataService",function(t,n,i){return{scope:{showSettings:"=",graphHeight:"=",functions:"="},templateUrl:"partials/palladio-graph-component/template.html",link:{pre:function(e,o,a){function l(){var t=e.mapping.sourceDimension?function(t){return t[e.mapping.sourceDimension.key]}:null,n=e.mapping.targetDimension?function(t){return t[e.mapping.targetDimension.key]}:null;e.linkDimension&&e.linkDimension.remove(),e.mapping.sourceDimension&&e.mapping.targetDimension&&(e.linkDimension=e.xfilter.dimension(function(i){return[t(i),n(i)]}),e.linkDimension.accessor=function(i){return[t(i),n(i)]})}function g(t){e.showLinks=t.showLinks,e.showLabels=t.showLabels,e.nodeSize=t.nodeSize,e.highlightSource=t.highlightSource,e.highlightTarget=t.highlightTarget,e.countDim=t.countDim,e.mapping.sourceDimension=e.fields.filter(function(n){return n.key===t.sourceDimension})[0],e.mapping.targetDimension=e.fields.filter(function(n){return n.key===t.targetDimension})[0],t.aggDimKey&&(e.aggDim=e.aggDims.filter(function(n){return n.key===t.aggDimKey})[0]),e.$digest(),e.setInternalState(t)}function s(){return e.readInternalState({showLinks:e.showLinks,showLabels:e.showLabels,aggregateKey:e.aggregateKey,aggregationType:e.aggregationType,nodeSize:e.nodeSize,highlightSource:e.highlightSource,highlightTarget:e.highlightTarget,countDim:e.countDim,aggDimKey:e.aggDim.key,sourceDimension:e.mapping.sourceDimension?e.mapping.sourceDimension.key:null,targetDimension:e.mapping.targetDimension?e.mapping.targetDimension.key:null})}void 0===e.showSettings?e.settings=!0:e.settings=e.showSettings;var c=[];e.metadata=i.getDataSync().metadata,e.xfilter=i.getDataSync().xfilter,e.uniqueToggleId="graphView"+Math.floor(1e4*Math.random()),e.uniqueModalId=e.uniqueToggleId+"modal",e.fields=e.metadata.sort(function(t,n){return t.description<n.description?-1:1}),e.dateFields=e.metadata.filter(function(t){return"date"===t.type}),e.mapping={},e.nodeSize=!1,e.showLabels=!0,e.circleLayout=!1,e.highlightSource=!1,e.highlightTarget=!1,e.showLinks=!0,e.getAggDescription=function(t){return"count"===t.type?"Number of "+t.field.countDescription:"Sum of "+t.field.description+" (from "+r.get(t.fileId).countDescription+" table)"};var r=d3.map();e.metadata.filter(function(t){return t.countable===!0}).forEach(function(t){r.set(t.originFileId?t.originFileId:0,t)}),e.aggDims=e.metadata.filter(function(t){return t.countable===!0||"number"===t.type}).map(function(t){return{key:t.key,type:t.countable?"count":"sum",field:t,fileId:t.originFileId?t.originFileId:0}}).filter(function(t){return!!r.get(t.fileId)}).sort(function(t,n){return e.getAggDescription(t)<e.getAggDescription(n)?-1:1}),e.aggDim=e.aggDims[0],e.$watch("aggDim",function(){e.aggDim?"count"===e.aggDim.type?(e.countBy=e.aggDim.key,e.aggregationType="COUNT",e.aggregateKey=null,e.aggDescription=e.getAggDescription(e.aggDim)):(e.countBy=r.get(e.aggDim.fileId).key,e.aggregationType="SUM",e.aggregateKey=e.aggDim.key,e.aggDescription=e.getAggDescription(e.aggDim)):e.countBy=e.countDims.get(0).key}),e.showAggModal=function(){$("#"+e.uniqueModalId).find("#agg-modal").modal("show")},e.$watch("mapping.sourceDimension",function(){l()}),e.$watch("mapping.targetDimension",function(){l()}),e.$on("$destroy",function(){e.linkDimension&&e.linkDimension.remove(),c.forEach(function(t){t()})}),e.resetNodes=function(){e.$broadcast("resetNodes")},e.showSourceModal=function(){$("#source-modal").modal("show")},e.showTargetModal=function(){$("#target-modal").modal("show")},e.clearDimensions=function(){e.mapping.sourceDimension=null,e.mapping.targetDimension=null},e.zoomIn=function(){e.$broadcast("zoomIn")},e.zoomOut=function(){e.$broadcast("zoomOut")},e.zoomToData=function(){e.$broadcast("zoomToData")},e.setInternalState=function(t){return t},e.readInternalState=function(t){return t},e.getSvg=function(){return{}},e.exportSvg=function(n,i){t(e.getSvg(),i)},c.push(n.registerStateFunctions(e.uniqueToggleId,"graphView",s,g)),e.functions&&(e.functions.source=function(t){e.$apply(function(n){n.mapping.sourceDimension=n.fields.filter(function(n){return n.key===t.key})[0]})},e.functions.target=function(t){e.$apply(function(n){n.mapping.targetDimension=n.fields.filter(function(n){return n.key===t.key})[0]})},e.functions.showLinks=function(t){e.$apply(function(n){n.showLinks=t})},e.functions.showLabels=function(t){e.$apply(function(n){n.showLabels=t})},e.functions.nodeSize=function(t){e.$apply(function(n){n.nodeSize=t})},e.functions.zoomOut=function(){e.$apply(function(t){t.zoomOut()})},e.functions.zoomIn=function(){e.$apply(function(t){t.zoomIn()})},e.functions.zoomToData=function(){e.$apply(function(t){t.zoomToData()})},e.functions.getSettings=function(){return o.find(".graph-settings")[0]},e.functions.importState=function(t){return g(t),!0},e.functions.exportState=function(){return s()})},post:function(t,n,i){n.find(".settings-toggle").click(function(){n.find(".settings").toggleClass("closed")}),t.graphHeight&&n.height(t.graphHeight)}}}}]),angular.module("palladio").run(["$templateCache",function(t){t.put("partials/palladio-graph-component/template.html",'<div class="">\n\n\t<div data-palladio-graph-view\n\t\tgraph-height="graphHeight"\n\t\tstyle="margin-bottom: -55px"\n\t\tlink-dimension="linkDimension"\n\t\tshow-links="showLinks"\n\t\tshow-labels="showLabels"\n\t\thighlight-source="highlightSource"\n\t\thighlight-target="highlightTarget"\n\t\tread-internal-state="readInternalState"\n\t\tset-internal-state="setInternalState"\n\t\tget-svg="getSvg"\n\t\tnode-size="nodeSize"\n\t\tdata-aggregation-type="{{aggregationType}}"\n\t\tdata-aggregate-key="{{aggregateKey}}"\n\t\tcount-by="{{countBy}}"\n\t\tcount-description="{{aggDescription}}">\n\n\t\t<div class="leaflet-top leaflet-left">\n\t\t\t<div class="leaflet-control-zoom-graph leaflet-bar leaflet-control">\n\t\t\t\t<a class="leaflet-control-zoom-in" ng-click="zoomIn()" title="Zoom in">+</a>\n\t\t\t\t<a class="leaflet-control-zoom-out" ng-click="zoomOut()" title="Zoom out">-</a>\n\t\t\t</div>\n\t\t\t<div class="zoom-to-data-control leaflet-bar leaflet-control">\n\t\t\t\t<a class="leaflet-control-to-data" title="Zoom to data" ng-click="zoomToData()"><i class="fa fa-object-group"></i></a>\n\t\t\t</div>\n\t\t</div>\n\n</div>\n\n<!-- Settings -->\n<div class="row graph-settings" data-ng-show="settings">\n\n    <div class="settings col-lg-4 col-lg-offset-8 col-md-6 col-md-offset-6">\n      <div class="panel panel-default">\n\n        <a class="settings-toggle" data-toggle="tooltip" data-original-title="Settings" data-placement="bottom">\n          <i class="fa fa-bars"></i>\n        </a>\n\n        <div class="panel-body">\n\n          <div class="row">\n            <div class="col-lg-12">\n              <label>Settings</label>\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Source</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showSourceModal()">\n                  {{mapping.sourceDimension.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n\t\t\t\t\t<div class="row margin-top">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n\t\t\t\t\t\t\t<label class="inline">Highlight</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t\t<input type="checkbox" ng-model="highlightSource">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Target</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showTargetModal()">\n                  {{mapping.targetDimension.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n\t\t\t\t\t<div class="row margin-top">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n\t\t\t\t\t\t\t<label class="inline">Highlight</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t\t<input type="checkbox" ng-model="highlightTarget">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\n\t\t\t\t\t<div class="row margin-top">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n\t\t\t\t\t\t\t<label class="inline">Show links</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t\t<input type="checkbox" ng-model="showLinks">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="row margin-top">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n\t\t\t\t\t\t\t<label class="inline">Size nodes</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t\t<input type="checkbox" ng-model="nodeSize">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="row margin-top" data-ng-show="nodeSize">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n\t\t\t\t\t\t\t<label class="inline">According to</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t<span class="btn btn-default" ng-click="showAggModal()">\n\t\t\t\t\t\t\t\t{{getAggDescription(aggDim) || "Choose"}}\n\t\t\t\t\t\t\t\t<span class="caret"></span>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="row margin-top">\n\t\t\t\t\t\t<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right ">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="col-lg-8 col-md-8 col-md-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t<a class="pull-right"\n\t\t\t\t\t\t\ttooltip="Download graph (svg)"\n\t\t\t\t\t\t\ttooltip-animation="false"\n\t\t\t\t\t\t\ttooltip-append-to-body="true"\n\t\t\t\t\t\t\tng-click="exportSvg(this, \'Palladio Graph.svg\')">\n\t\t\t\t\t\t\t\t<i class="fa fa-download margin-right"></i>Download\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\n\n\n\n        </div>\n\n      </div>\n    </div>\n\n</div>\n\n<div id="{{uniqueModalId}}">\n\t<div id="source-modal" data-modal description="Choose source dimension" dimensions="fields" model="mapping.sourceDimension"></div>\n\t<div id="target-modal" data-modal description="Choose target dimension" dimensions="fields" model="mapping.targetDimension"></div>\n\t<div id="agg-modal" data-modal description="Choose aggregation for sizing nodes" dimensions="aggDims" model="aggDim" description-accessor="getAggDescription"></div>\n</div>\n')}]);